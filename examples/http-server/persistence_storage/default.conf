SecDebugLogLevel 9
SecDebugLog /dev/stdout

# Rate limit requests from the same X-Real-IP
# Request example:
#      curl --header 'X-Real-IP: 8.8.8.8' http://localhost:8090/
# Repeat the request 4 times to trigger the rate limit.

# Extract the client real IP from the X-Real-IP header
SecRule REQUEST_HEADERS:X-Real-IP "." "id:2000,phase:1,nolog,pass,setvar:tx.real_ip=%{MATCHED_VAR},expirevar:tx.real_ip"

# Initialize the IP collection using the extracted IP
SecAction "id:2001,phase:1,nolog,pass,initcol:ip=%{TX.real_ip}"

# Increment request count for this IP
SecAction "id:2002,phase:2,nolog,pass,setvar:ip.request_count=+1"

# Block IP after 3 requests
SecRule IP:request_count "@ge 4" \
    "id:2003,phase:2,deny,log,msg:'Rate limit exceeded for IP %{TX.real_ip}'"
