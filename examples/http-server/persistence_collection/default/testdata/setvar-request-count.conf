SecDebugLogLevel 9
SecDebugLog /dev/stdout

# Rate limit requests from the same X-Real-IP
# Request example:
#      curl --header 'X-Session-ID: unique-session-id' http://localhost:8090/
# Repeat the request 4 times to trigger the rate limit.


# Extract the session ID from the header
SecRule REQUEST_HEADERS:X-Session-ID ".*" \
    "id:3001,phase:1,nolog,pass,setvar:tx.session_id=%{MATCHED_VAR}"

# Initialize the SESSION collection using the session ID
SecAction "id:3002,phase:1,nolog,pass,initcol:session=%{TX.session_id}"

# Example: Increment a session variable
SecAction "id:3003,phase:2,nolog,pass,setvar:session.request_count=+1"

# Block if the session has made too many requests
SecRule SESSION:request_count "@ge 3" \
    "id:3005,phase:2,deny,log,msg:'Session %{TX.session_id} exceeded request limit'"
